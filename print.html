<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Print Labels</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    *{ box-sizing:border-box; }
    html, body{
      margin:0;
      padding:0;
      background:#fff;
    }

    /* IMPORTANT: label is 4" wide x 6" tall */
    @page{
      size: 4in 6in;
      margin: 0;
    }

    @media print{
      html, body{ background:#fff; }
    }

    /* Each .page becomes exactly one printed label */
    .page{
      width: 4in;
      height: 6in;
      background:#fff;
      display:flex;
      align-items:stretch;
      justify-content:stretch;
      break-after: page;
      page-break-after: always;
    }
    .page:last-child{
      break-after: auto;
      page-break-after: auto;
    }

    .label{
      width:100%;
      height:100%;
      padding: 0.32in 0.34in; /* adjust margins on the label itself */
      display:flex;
      flex-direction:column;
      gap: 0.18in;
      overflow:hidden;
      background:#fff;
    }

    .header{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;

      /* thicker/bigger so it doesn't print faint */
      font-size: 14pt;
      font-weight: 900;
      letter-spacing: .10em;
      text-transform: uppercase;
      color:#000;
    }

    /* Removed "STAGED ORDER" completely */
    .header .right{ display:none; }

    .center{
      flex:1;
      display:flex;
      align-items:center;
      justify-content:center;
      text-align:center;
      overflow:hidden;
    }

    .customer-name{
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      font-weight: 900;
      color:#000;
      line-height: 1.02;
      letter-spacing: .01em;
      word-break: break-word;
      overflow:hidden;

      /* start big, we will auto-fit down */
      font-size: 120pt;
      max-height:100%;
      max-width:100%;
    }

    .footer{
      display:flex;
      justify-content:space-between;
      gap: 0.2in;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:#000;
      text-transform: uppercase;
      font-weight: 900;
      letter-spacing: .02em;
    }

    .footer .left,
    .footer .right{
      font-size: 16pt; /* bigger to avoid “tiny bleed” */
      line-height: 1.15;
      white-space:nowrap;
    }

    .footer .left .order{
      display:none; /* only show if order exists */
    }
  </style>
</head>

<body>
  <div id="printLabels"></div>

  <script>
    function getParam(name){
      const url = new URL(window.location.href);
      return url.searchParams.get(name) || '';
    }

    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, m => ({
        '&':'&amp;',
        '<':'&lt;',
        '>':'&gt;',
        '"':'&quot;',
        "'":'&#39;'
      }[m]));
    }

    function formatShipDate(yyyy_mm_dd){
      if(!yyyy_mm_dd) return '';
      const [y,m,d] = yyyy_mm_dd.split('-').map(Number);
      if(!y || !m || !d) return '';
      const mm = String(m).padStart(2,'0');
      const dd = String(d).padStart(2,'0');
      return `${mm}/${dd}/${y}`;
    }

    function autoFitText(el){
      // Shrink until it fits inside its parent
      const parent = el.parentElement;
      if(!parent) return;

      const max = 128; // starting pt-ish
      const min = 34;

      el.style.fontSize = max + 'pt';

      for(let size = max; size >= min; size--){
        el.style.fontSize = size + 'pt';
        if(el.scrollHeight <= parent.clientHeight && el.scrollWidth <= parent.clientWidth){
          break;
        }
      }
    }

    function makeLabelHTML({ customer, order, palletText, shipText }){
      const safeCustomer = escapeHtml(customer);
      const safeOrder = escapeHtml(order);
      const safePallet = escapeHtml(palletText);
      const safeShip = escapeHtml(shipText);

      return `
        <div class="page">
          <div class="label">
            <div class="header">
              <div class="left">APOLLON WIRE &amp; CABLE</div>
              <div class="right"></div>
            </div>

            <div class="center">
              <div class="customer-name">${safeCustomer}</div>
            </div>

            <div class="footer">
              <div class="left">
                <div class="order">ORDER: <span class="orderVal">${safeOrder}</span></div>
                <div>PALLET: <span>${safePallet}</span></div>
              </div>

              <div class="right">
                <div>SHIP: <span>${safeShip}</span></div>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function buildPrintPages(){
      const customer = getParam('customer').trim();
      const order = getParam('order').trim();
      const total = Math.max(1, parseInt(getParam('total') || '1', 10));
      const start = Math.max(1, parseInt(getParam('start') || '1', 10));
      const shipText = formatShipDate(getParam('ship'));

      const container = document.getElementById('printLabels');
      container.innerHTML = '';

      const pages = [];
      for(let i = 0; i < total; i++){
        const n = start + i;
        pages.push(makeLabelHTML({
          customer,
          order,
          palletText: `${n} of ${total}`,
          shipText
        }));
      }

      container.innerHTML = pages.join('');

      // show order line only when order exists
      container.querySelectorAll('.order').forEach(el=>{
        el.style.display = order ? 'block' : 'none';
      });

      // auto-fit customer names
      container.querySelectorAll('.customer-name').forEach(el => autoFitText(el));
    }

    window.addEventListener('DOMContentLoaded', ()=>{
      buildPrintPages();
      window.print();
    });
  </script>
</body>
</html>

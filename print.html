<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Print Labels</title>

  <style>
    /* Force label stock size (4" wide x 6" tall) */
    @page { size: 4in 6in; margin: 0; }
    html, body {
      width: 4in;
      height: 6in;
      margin: 0;
      padding: 0;
      background: #fff;
      color: #000;
      overflow: hidden;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }

    /* Container holds multiple pages */
    #printLabels { margin: 0; padding: 0; }

    .label {
      width: 4in;
      height: 6in;
      padding: 0.35in 0.35in; /* safe margin to keep away from edges */
      display: flex;
      flex-direction: column;
      background: #fff;
      page-break-after: always;
      break-after: page;
    }
    .label:last-child {
      page-break-after: auto;
      break-after: auto;
    }

    /* Header: thicker + bigger to reduce bleeding */
    .header {
      font-weight: 900;
      font-size: 16pt;
      letter-spacing: .10em;
      text-transform: uppercase;
      line-height: 1.1;
    }

    .main {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: 0.15in 0;
      overflow: hidden;
    }

    .customer-name {
      font-weight: 900;
      letter-spacing: .02em;
      line-height: 0.98;
      word-break: break-word;
      overflow-wrap: anywhere;
      /* starting size - JS will shrink as needed */
      font-size: 130pt;
    }

    .footer {
      display: flex;
      justify-content: space-between;
      gap: 0.25in;
      font-weight: 900;
      text-transform: uppercase;
      letter-spacing: .04em;
      font-size: 14pt; /* bigger to avoid thin bleed */
      line-height: 1.15;
    }
    .footer .left {
      display: flex;
      flex-direction: column;
      gap: 6px;
      min-width: 0;
    }
    .footer .right {
      white-space: nowrap;
      align-self: flex-end;
    }

    /* Ensure Chrome doesn't try to print backgrounds/margins weirdly */
    @media print {
      html, body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
    }
  </style>
</head>

<body>
  <div id="printLabels"></div>

  <script>
    function getParam(name){
      const url = new URL(window.location.href);
      return url.searchParams.get(name) || '';
    }

    function formatShipDate(val){
      if(!val) return 'â€”';
      const d = new Date(val + 'T00:00:00');
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const dd = String(d.getDate()).padStart(2,'0');
      const yy = d.getFullYear();
      return `${mm}/${dd}/${yy}`;
    }

    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, m => ({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
      }[m]));
    }

    function makeLabelHTML({ customer, order, palletText, shipText }){
      const orderLine = order
        ? `<div>ORDER: ${escapeHtml(order)}</div>`
        : ``;

      return `
        <div class="label">
          <div class="header">APOLLON WIRE &amp; CABLE</div>

          <div class="main">
            <div class="customer-name">${escapeHtml(customer)}</div>
          </div>

          <div class="footer">
            <div class="left">
              ${orderLine}
              <div>PALLET: ${escapeHtml(palletText)}</div>
            </div>
            <div class="right">SHIP: ${escapeHtml(shipText)}</div>
          </div>
        </div>
      `;
    }

    function autoFitText(el){
      const label = el.closest('.label');
      const header = label.querySelector('.header');
      const footer = label.querySelector('.footer');
      const main = label.querySelector('.main');

      // Ensure main area is measured correctly
      const maxW = main.clientWidth;
      const maxH = main.clientHeight;

      let size = 140;   // start big, shrink down
      const min = 28;   // don't go too tiny
      el.style.fontSize = size + 'pt';

      // shrink until it fits
      while ((el.scrollWidth > maxW || el.scrollHeight > maxH) && size > min) {
        size -= 2;
        el.style.fontSize = size + 'pt';
      }
    }

    function buildPrintPages(){
      const customer = getParam('customer') || 'CUSTOMER';
      const order = getParam('order');
      const total = Math.max(1, parseInt(getParam('total') || '1', 10));
      const start = Math.max(1, parseInt(getParam('start') || '1', 10));
      const shipText = formatShipDate(getParam('ship'));

      const container = document.getElementById('printLabels');
      container.innerHTML = '';

      let html = '';
      for(let i=0; i<total; i++){
        const n = start + i;
        html += makeLabelHTML({
          customer,
          order,
          palletText: `${n} of ${total}`,
          shipText
        });
      }
      container.innerHTML = html;

      // Auto-fit each customer name AFTER DOM paints
      requestAnimationFrame(() => {
        container.querySelectorAll('.customer-name').forEach(el => autoFitText(el));
        // print after fit
        setTimeout(() => window.print(), 80);
      });
    }

    window.addEventListener('DOMContentLoaded', buildPrintPages);
  </script>
</body>
</html>

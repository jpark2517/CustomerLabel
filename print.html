<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Print Labels</title>
  <style>
    /* IMPORTANT: true label size */
    @page {
      size: 4in 6in;   /* width height (portrait) */
      margin: 0;
    }

    html, body {
      margin: 0;
      padding: 0;
      background: #fff;
    }

    /* Avoid any weird extra page */
    body { overflow: hidden; }

    .printWrap{
      width: 100%;
      margin: 0;
      padding: 0;
      background: #fff;
    }

    /* each .page is EXACTLY 4x6 */
    .page{
      width: 4in;
      height: 6in;
      background: #fff;
      position: relative;
      overflow: hidden;

      /* padding tuned so nothing is “too close to the middle” */
      padding: 0.35in 0.30in 0.35in 0.30in;

      page-break-after: always;
      break-after: page;
    }
    .page:last-child{
      page-break-after: auto;
      break-after: auto;
    }

    /* BRAND (make it not tiny so it doesn’t bleed) */
    .brand{
      position:absolute;
      top: 0.35in;
      left: 0.30in;
      font-weight: 900;
      letter-spacing: 1.1px;
      text-transform: uppercase;
      font-size: 15px;   /* thicker than before */
      color:#000;
    }

    /* MAIN NAME AREA */
    .nameBox{
      position:absolute;
      left: 0.30in;
      right: 0.30in;
      top: 0.95in;
      bottom: 1.20in; /* reserve for footer + order line */
      display:flex;
      align-items:center;
      justify-content:center;
      text-align:center;
      overflow:hidden;
    }

    .customerName{
      font-weight: 900;
      line-height: 1.05;
      letter-spacing: .2px;
      font-size: 120px;     /* starting size, JS will reduce if needed */
      color:#000;
      word-break: keep-all;
      overflow-wrap: break-word;
    }

    /* FOOTER */
    .footer{
      position:absolute;
      left: 0.30in;
      right: 0.30in;
      bottom: 0.35in;
      display:flex;
      justify-content:space-between;
      gap: 0.20in;
      font-weight: 900;
      text-transform: uppercase;
      font-size: 16px;     /* thicker so thermal doesn’t fuzz */
      letter-spacing: .9px;
      color:#000;
    }

    .footerLeft{
      flex: 1 1 auto;
      min-width: 0;
    }
    .footerRight{
      flex: 0 0 auto;
      white-space: nowrap;
      text-align:right;
    }

    .orderLine{
      margin-top: 0.12in;
      font-size: 16px;
      letter-spacing: .9px;
      font-weight: 900;
      display:none; /* only show if order is present */
    }

    /* Make screen preview not huge while still printing correctly */
    @media screen {
      body{ background:#ddd; overflow:auto; }
      .printWrap{
        padding: 24px 0;
        display:flex;
        justify-content:center;
      }
      .page{
        box-shadow: 0 12px 30px rgba(0,0,0,.25);
        border: 1px solid rgba(0,0,0,.12);
        margin: 0 0 18px 0;
      }
    }
  </style>
</head>
<body>
  <div class="printWrap" id="printLabels"></div>

  <script>
    function getParam(key) {
      const url = new URL(window.location.href);
      return url.searchParams.get(key) || "";
    }

    function escapeHtml(s) {
      return String(s).replace(/[&<>"']/g, (m) => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
      }[m]));
    }

    function fmtShip(dateStr) {
      // YYYY-MM-DD -> MM/DD/YYYY
      if (!dateStr) return "";
      const parts = dateStr.split("-");
      if (parts.length !== 3) return "";
      const [y,m,d] = parts;
      if (!y || !m || !d) return "";
      return `${m}/${d}/${y}`;
    }

    function clampInt(val, fallback=1) {
      const n = parseInt(val, 10);
      return Number.isFinite(n) && n > 0 ? n : fallback;
    }

    function makeLabelHTML({ customer, order, palletText, shipText }) {
      const safeCustomer = escapeHtml(customer);
      const safeOrder = escapeHtml(order);
      const safePallet = escapeHtml(palletText);
      const safeShip = escapeHtml(shipText);

      const showOrder = Boolean(order && order.trim());

      return `
        <div class="page">
          <div class="brand">APOLLON WIRE &amp; CABLE</div>

          <div class="nameBox">
            <div class="customerName customer-name">${safeCustomer}</div>
          </div>

          <div class="footer">
            <div class="footerLeft">
              <div>${safePallet}</div>
              <div class="orderLine" style="${showOrder ? "display:block" : "display:none"}">
                ORDER: ${safeOrder}
              </div>
            </div>
            <div class="footerRight">SHIP: ${safeShip}</div>
          </div>
        </div>
      `;
    }

    // Auto-fit the big customer name so long names don't explode the label.
    function autoFitText(el) {
      const box = el.parentElement; // .nameBox
      const maxH = box.clientHeight;
      const maxW = box.clientWidth;

      let size = 120;     // start big
      const minSize = 26; // never go below this

      el.style.fontSize = size + "px";

      // shrink until it fits
      while (size >= minSize) {
        el.style.fontSize = size + "px";
        if (el.scrollHeight <= maxH && el.scrollWidth <= maxW) break;
        size -= 2;
      }
    }

    function buildPrintPages() {
      const customer = getParam("customer");
      const order = getParam("order");
      const total = clampInt(getParam("total") || "1", 1);
      const start = clampInt(getParam("start") || "1", 1);
      const shipText = fmtShip(getParam("ship")) || "MM/DD/YYYY";

      const container = document.getElementById("printLabels");
      container.innerHTML = "";

      const pages = [];
      for (let i = 0; i < total; i++) {
        const n = start + i;
        pages.push(makeLabelHTML({
          customer,
          order,
          palletText: `PALLET: ${n} OF ${total}`,
          shipText
        }));
      }

      container.innerHTML = pages.join("");

      // fit each label name
      container.querySelectorAll(".customer-name").forEach(el => autoFitText(el));
    }

    window.addEventListener("DOMContentLoaded", () => {
      buildPrintPages();
      // open print dialog automatically
      window.print();
    });
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Label Control</title>

  <style>
    :root{
      --bg: #0b1220;
      --card: rgba(15,23,42,.78);
      --line: rgba(148,163,184,.22);
      --muted: #94a3b8;
      --text: #f8fafc;
      --accent: #3b82f6;
      --accent2:#1d4ed8;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      padding:24px 16px;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(circle at top, #111827 0%, #020617 60%, #000 100%);
      color: var(--text);
      display:flex;
      justify-content:center;
    }

    .app{ width:100%; max-width:980px; }

    .card{
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 18px;
      box-shadow: 0 18px 60px rgba(0,0,0,.55);
      padding:18px;
      backdrop-filter: blur(16px);
    }

    h1{
      margin:0 0 14px;
      font-size:1.2rem;
      font-weight:800;
      letter-spacing:.01em;
    }

    .grid{
      display:grid;
      grid-template-columns: 1.25fr .95fr;
      gap:16px;
      align-items:start;
    }
    @media (max-width:900px){
      .grid{ grid-template-columns: 1fr; }
    }

    .field{
      display:flex;
      flex-direction:column;
      gap:6px;
      margin-bottom:12px;
    }
    label{
      font-size:.72rem;
      letter-spacing:.09em;
      text-transform:uppercase;
      color: var(--muted);
    }

    input, select{
      width:100%;
      background:#070b16;
      border:1px solid rgba(148,163,184,.32);
      color:var(--text);
      border-radius:12px;
      padding:10px 12px;
      outline:none;
      font-size:.95rem;
    }
    input:focus, select:focus{
      border-color: rgba(59,130,246,.9);
      box-shadow: 0 0 0 2px rgba(59,130,246,.2);
    }

    .row{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    @media (max-width:900px){
      .row{ grid-template-columns:1fr; }
    }

    .btnbar{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      margin-top:6px;
    }
    button{
      border:none;
      cursor:pointer;
      border-radius:999px;
      padding:10px 16px;
      font-weight:700;
      color:#fff;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      box-shadow: 0 10px 24px rgba(37,99,235,.35);
    }
    button.secondary{
      background: transparent;
      color: var(--text);
      border: 1px solid rgba(148,163,184,.35);
      box-shadow:none;
      font-weight:700;
    }

    /* Admin panel */
    .admin{
      margin-top:14px;
      padding:12px;
      border-radius:14px;
      border:1px dashed rgba(148,163,184,.35);
      background: rgba(2,6,23,.35);
    }
    .admin small{
      color: var(--muted);
      display:block;
      margin-top:6px;
      font-size:.78rem;
    }
    .admin-controls{
      display:none;
      gap:10px;
      margin-top:12px;
      align-items:flex-end;
      flex-wrap:wrap;
    }
    .admin-controls .mini{
      flex: 1 1 260px;
    }
    .danger{
      background: linear-gradient(135deg, #ef4444, #b91c1c);
      box-shadow: 0 10px 24px rgba(239,68,68,.30);
    }

    /* Preview card */
    .previewWrap{
      display:flex;
      justify-content:center;
    }

    .labelPreview{
      width: 420px;
      max-width:100%;
      aspect-ratio: 4 / 3; /* just preview proportion */
      background:#fff;
      border-radius:14px;
      box-shadow: 0 20px 50px rgba(0,0,0,.35);
      overflow:hidden;
      border: 1px solid rgba(0,0,0,.08);
      display:flex;
      flex-direction:column;
    }

    .lp-header{
      display:flex;
      justify-content:flex-start;
      padding:14px 16px 6px 16px;
      font-weight:900;
      letter-spacing:.08em;
      text-transform:uppercase;
      font-size:14px;          /* thicker = less bleeding */
      color:#000;
    }

    .lp-main{
      flex:1;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 8px 18px;
      text-align:center;
    }
    .lp-customer{
      font-weight:900;
      color:#000;
      line-height:1.02;
      letter-spacing:.01em;
      word-break: break-word;
      overflow-wrap:anywhere;
      font-size: 92px; /* will be auto-fit down */
    }

    .lp-footer{
      display:flex;
      justify-content:space-between;
      gap:10px;
      padding: 8px 16px 14px 16px;
      font-size:14px;          /* thicker = less bleeding */
      font-weight:900;
      letter-spacing:.03em;
      text-transform:uppercase;
      color:#000;
    }
    .lp-left{
      display:flex;
      flex-direction:column;
      gap:4px;
      min-width: 0;
    }
    .lp-right{
      display:flex;
      align-items:flex-end;
      white-space:nowrap;
    }
    .mutedHint{
      color: rgba(148,163,184,.85);
      font-size:.82rem;
      margin-top:8px;
    }
    .divider{
      height:1px;
      background: rgba(148,163,184,.20);
      margin: 14px 0;
    }
  </style>
</head>

<body>
  <div class="app">
    <div class="card">
      <h1>Label Control</h1>

      <div class="grid">
        <!-- LEFT: Controls -->
        <div>
          <div class="field">
            <label for="presetSelect">Customer Preset</label>
            <select id="presetSelect">
              <option value="">— Select customer —</option>
            </select>
          </div>

          <div class="field">
            <label for="customerName">Customer Name</label>
            <input id="customerName" placeholder="Mr. Supply / Home Depot / etc." />
          </div>

          <div class="row">
            <div class="field">
              <label for="orderNumber">Order # (optional)</label>
              <input id="orderNumber" placeholder="SO-12345"/>
            </div>

            <div class="field">
              <label for="totalPallets">Total Pallets (e.g. 12)</label>
              <input id="totalPallets" type="number" min="1" value="1"/>
            </div>
          </div>

          <div class="row">
            <div class="field">
              <label for="shipDate">Ship Date</label>
              <input id="shipDate" type="date"/>
            </div>

            <div class="field">
              <label for="startPallet">Start Pallet # (optional)</label>
              <input id="startPallet" type="number" min="1" value="1"/>
            </div>
          </div>

          <div class="btnbar">
            <button type="button" id="printBtn">Print Pallet Labels</button>
            <button type="button" class="secondary" id="clearBtn">Clear</button>
          </div>

          <div class="mutedHint">
            Prints 1 of N, 2 of N, … on separate labels via <b>print.html</b>.
          </div>

          <div class="divider"></div>

          <!-- ADMIN -->
          <div class="admin">
            <div class="field">
              <label for="adminPassword">Admin (manage presets)</label>
              <input id="adminPassword" type="password" placeholder="Enter password"/>
              <small>Hint: Hank Jung's 1st year working @ Apollon</small>
            </div>

            <div class="btnbar">
              <button type="button" class="secondary" id="unlockBtn">Unlock</button>
            </div>

            <div class="admin-controls" id="adminControls">
              <div class="field mini">
                <label for="newPresetName">Add preset</label>
                <input id="newPresetName" placeholder="New customer name"/>
              </div>
              <button type="button" id="addPresetBtn">Add</button>

              <div class="field mini">
                <label for="deletePresetSelect">Delete preset</label>
                <select id="deletePresetSelect"></select>
              </div>
              <button type="button" class="danger" id="deletePresetBtn">Delete</button>
            </div>
          </div>
        </div>

        <!-- RIGHT: Preview -->
        <div class="previewWrap">
          <div class="labelPreview" id="labelPreview">
            <div class="lp-header" id="pvHeader">APOLLON WIRE &amp; CABLE</div>

            <div class="lp-main">
              <div class="lp-customer" id="pvCustomer">CUSTOMER</div>
            </div>

            <div class="lp-footer">
              <div class="lp-left">
                <div id="pvOrderLine" style="display:none;">ORDER: <span id="pvOrder"></span></div>
                <div>PALLET: <span id="pvPalletText">1 of 1</span></div>
              </div>
              <div class="lp-right">
                SHIP: <span id="pvShip">—</span>
              </div>
            </div>
          </div>
        </div>
      </div> <!-- grid -->
    </div>
  </div>

<script>
  // === CONFIG ===
  // Your Google Apps Script Web App URL (keep yours here):
  const API_URL = 'https://script.google.com/macros/s/AKfycbyr5srvdX4ZS90bze7PDXNm41sA7VNLcTiO8WBjkcVTdjTThL1bXx24-oAzJ3L0nGsE/exec';

  // Admin password (same as your existing)
  const ADMIN_PASSWORD = '2024';

  // === Elements ===
  const presetSelect = document.getElementById('presetSelect');
  const customerName = document.getElementById('customerName');
  const orderNumber = document.getElementById('orderNumber');
  const totalPallets = document.getElementById('totalPallets');
  const shipDate = document.getElementById('shipDate');
  const startPallet = document.getElementById('startPallet');

  const pvCustomer = document.getElementById('pvCustomer');
  const pvOrderLine = document.getElementById('pvOrderLine');
  const pvOrder = document.getElementById('pvOrder');
  const pvPalletText = document.getElementById('pvPalletText');
  const pvShip = document.getElementById('pvShip');

  const adminPassword = document.getElementById('adminPassword');
  const adminControls = document.getElementById('adminControls');
  const newPresetName = document.getElementById('newPresetName');
  const deletePresetSelect = document.getElementById('deletePresetSelect');

  const printBtn = document.getElementById('printBtn');
  const clearBtn = document.getElementById('clearBtn');
  const unlockBtn = document.getElementById('unlockBtn');
  const addPresetBtn = document.getElementById('addPresetBtn');
  const deletePresetBtn = document.getElementById('deletePresetBtn');

  // === Presets ===
  const defaultCustomerPresets = [
    'City Electric Supply',
    'College Point',
    'Graybar',
    'Home Depot',
    'Lowe’s',
    'Mr. Supply',
    'Priority Wire & Cable',
    'Schwing Uniondale',
    'Turtle & Hughes'
  ];
  let customerPresets = [...defaultCustomerPresets];
  let adminUnlocked = false;

  function sortPresets(list){
    return [...list].sort((a,b)=>a.localeCompare(b, undefined, {sensitivity:'base'}));
  }

  function buildPresetControls(){
    const sorted = sortPresets(customerPresets);

    // main dropdown
    presetSelect.innerHTML = '';
    const ph = document.createElement('option');
    ph.value = '';
    ph.textContent = '— Select customer —';
    presetSelect.appendChild(ph);

    sorted.forEach(name=>{
      const o = document.createElement('option');
      o.value = name;
      o.textContent = name;
      presetSelect.appendChild(o);
    });

    // delete dropdown
    deletePresetSelect.innerHTML = '';
    sorted.forEach(name=>{
      const o = document.createElement('option');
      o.value = name;
      o.textContent = name;
      deletePresetSelect.appendChild(o);
    });
  }

  async function fetchPresetsFromApi(){
    try{
      const res = await fetch(API_URL + '?action=list', { method:'GET' });
      if(!res.ok) throw new Error('bad_network');
      const data = await res.json();
      if(Array.isArray(data.customers) && data.customers.length){
        customerPresets = data.customers;
      }
    }catch(e){
      console.warn('Preset API failed, using defaults.', e);
    }
    buildPresetControls();
  }

  // === Admin actions ===
  function unlockAdmin(){
    if(adminPassword.value === ADMIN_PASSWORD){
      adminUnlocked = true;
      adminControls.style.display = 'flex';
    }else{
      adminUnlocked = false;
      adminControls.style.display = 'none';
      alert('Incorrect password.');
    }
  }

  async function addPreset(){
    if(!adminUnlocked) return alert('Unlock admin first.');
    const name = (newPresetName.value || '').trim();
    if(!name) return;

    try{
      const payload = { action:'add', name, adminKey: ADMIN_PASSWORD };
      const res = await fetch(API_URL, {
        method:'POST',
        body: new URLSearchParams({ payload: JSON.stringify(payload) })
      });
      const text = await res.text();
      const data = JSON.parse(text);
      if(!data.ok) throw new Error(data.error || 'add_failed');
      newPresetName.value = '';
      await fetchPresetsFromApi();
    }catch(e){
      console.error(e);
      alert('Error adding preset.');
    }
  }

  async function deletePreset(){
    if(!adminUnlocked) return alert('Unlock admin first.');
    const name = deletePresetSelect.value;
    if(!name) return;

    if(!confirm(`Delete preset "${name}"?`)) return;

    try{
      const payload = { action:'delete', name, adminKey: ADMIN_PASSWORD };
      const res = await fetch(API_URL, {
        method:'POST',
        body: new URLSearchParams({ payload: JSON.stringify(payload) })
      });
      const text = await res.text();
      const data = JSON.parse(text);
      if(!data.ok) throw new Error(data.error || 'delete_failed');
      await fetchPresetsFromApi();
    }catch(e){
      console.error(e);
      alert('Error deleting preset.');
    }
  }

  // === Preview helpers ===
  function formatShipDate(val){
    if(!val) return '—';
    const d = new Date(val + 'T00:00:00');
    const mm = String(d.getMonth()+1).padStart(2,'0');
    const dd = String(d.getDate()).padStart(2,'0');
    const yy = d.getFullYear();
    return `${mm}/${dd}/${yy}`;
  }

  function autoFitPreviewName(){
    const el = pvCustomer;
    const box = el.parentElement; // .lp-main
    let size = 110;
    const min = 28;

    el.style.fontSize = size + 'px';

    // shrink until it fits
    while((el.scrollWidth > box.clientWidth || el.scrollHeight > box.clientHeight) && size > min){
      size -= 2;
      el.style.fontSize = size + 'px';
    }
  }

  function updatePreview(){
    const cust = (customerName.value || '').trim() || 'CUSTOMER';
    pvCustomer.textContent = cust;

    const ord = (orderNumber.value || '').trim();
    if(ord){
      pvOrderLine.style.display = 'block';
      pvOrder.textContent = ord;
    }else{
      pvOrderLine.style.display = 'none';
      pvOrder.textContent = '';
    }

    const total = Math.max(1, parseInt(totalPallets.value || '1', 10));
    const start = Math.max(1, parseInt(startPallet.value || '1', 10));
    pvPalletText.textContent = `${start} of ${total}`;

    pvShip.textContent = formatShipDate(shipDate.value);

    autoFitPreviewName();
  }

  // === Printing ===
  function openPrintWindow(){
    const customer = (customerName.value || '').trim();
    const order = (orderNumber.value || '').trim();
    const total = Math.max(1, parseInt(totalPallets.value || '1', 10));
    const start = Math.max(1, parseInt(startPallet.value || '1', 10));
    const ship = shipDate.value || '';

    if(!customer){
      alert('Enter a Customer Name.');
      customerName.focus();
      return;
    }

    const params = new URLSearchParams();
    params.set('customer', customer);
    params.set('order', order);
    params.set('total', String(total));
    params.set('start', String(start));
    params.set('ship', ship);

    // IMPORTANT: must exist in repo root
    const url = './print.html?' + params.toString();
    window.open(url, '_blank', 'noopener,noreferrer');
  }

  function clearAll(){
    presetSelect.value = '';
    customerName.value = '';
    orderNumber.value = '';
    totalPallets.value = '1';
    startPallet.value = '1';
    setToday();
    updatePreview();
    customerName.focus();
  }

  function setToday(){
    const t = new Date();
    const yyyy = t.getFullYear();
    const mm = String(t.getMonth()+1).padStart(2,'0');
    const dd = String(t.getDate()).padStart(2,'0');
    shipDate.value = `${yyyy}-${mm}-${dd}`;
  }

  // === Events ===
  presetSelect.addEventListener('change', ()=>{
    customerName.value = presetSelect.value || '';
    updatePreview();
  });

  [customerName, orderNumber, totalPallets, startPallet, shipDate].forEach(el=>{
    el.addEventListener('input', updatePreview);
    el.addEventListener('change', updatePreview);
  });

  unlockBtn.addEventListener('click', unlockAdmin);
  addPresetBtn.addEventListener('click', addPreset);
  deletePresetBtn.addEventListener('click', deletePreset);
  printBtn.addEventListener('click', ()=>{ updatePreview(); openPrintWindow(); });
  clearBtn.addEventListener('click', clearAll);

  window.addEventListener('DOMContentLoaded', async ()=>{
    setToday();
    await fetchPresetsFromApi();
    updatePreview();
  });
</script>
</body>
</html>

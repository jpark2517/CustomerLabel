<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Staged Order Label Printer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    :root{
      --bg1:#111827;
      --bg2:#020617;
      --card:rgba(15,23,42,.65);
      --border:rgba(148,163,184,.28);
      --border2:rgba(148,163,184,.45);
      --text:#f9fafb;
      --muted:#9ca3af;
      --accent:#3b82f6;
      --accent2:#1d4ed8;
      --danger:#ef4444;
      --danger2:#b91c1c;
    }

    *{ box-sizing:border-box; }

    body{
      margin:0;
      padding:24px 16px;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:radial-gradient(circle at top,#111827 0%,#020617 55%,#000 100%);
      color:var(--text);
      display:flex;
      justify-content:center;
    }

    .app{ width:100%; max-width:920px; }

    .card{
      background:radial-gradient(circle at top left,#111827,var(--bg2));
      border:1px solid var(--border);
      border-radius:18px;
      padding:18px;
      box-shadow:0 12px 40px rgba(15,23,42,.7);
      backdrop-filter: blur(18px);
    }

    .title{
      font-size:1.35rem;
      font-weight:700;
      margin:0 0 10px;
    }

    label{
      display:block;
      font-size:.75rem;
      text-transform:uppercase;
      letter-spacing:.08em;
      color:var(--muted);
      margin:0 0 6px;
    }

    input, select{
      width:100%;
      background:#020617;
      color:var(--text);
      border:1px solid var(--border2);
      border-radius:12px;
      padding:10px 12px;
      outline:none;
      font-size:.95rem;
    }

    input:focus, select:focus{
      border-color:var(--accent);
      box-shadow:0 0 0 2px rgba(59,130,246,.18);
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap:14px;
    }

    .row2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px;
    }

    @media (max-width:720px){
      .row2{ grid-template-columns: 1fr; }
    }

    .btnbar{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      margin-top:6px;
    }

    button{
      border:none;
      border-radius:999px;
      padding:10px 16px;
      font-size:.95rem;
      font-weight:600;
      cursor:pointer;
      color:#fff;
      background:linear-gradient(135deg,var(--accent),var(--accent2));
      box-shadow:0 10px 24px rgba(37,99,235,.35);
    }

    button.secondary{
      background:transparent;
      color:var(--text);
      border:1px solid var(--border2);
      box-shadow:none;
    }

    button.danger{
      background:linear-gradient(135deg,var(--danger),var(--danger2));
      box-shadow:0 10px 24px rgba(239,68,68,.25);
    }

    .helper{
      margin-top:6px;
      font-size:.8rem;
      color:var(--muted);
    }

    .divider{
      margin:18px 0;
      height:1px;
      background:rgba(148,163,184,.18);
      border:0;
    }

    /* Preview label */
    .previewWrap{
      display:flex;
      justify-content:center;
      margin-top:8px;
    }

    .label{
      width:600px;   /* preview only */
      height:400px;  /* preview only */
      background:#fff;
      color:#111;
      border-radius:14px;
      box-shadow:0 18px 50px rgba(0,0,0,.25);
      padding:28px 34px;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
      overflow:hidden;
    }

    .labelTop{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:12px;
    }

    .brand{
      font-family: Arial, Helvetica, sans-serif;
      font-size:14pt;
      font-weight:800;
      letter-spacing:.06em;
      text-transform:uppercase;
      color:#000;
      line-height:1;
      white-space:nowrap;
    }

    .centerBox{
      flex:1;
      display:grid;
      place-items:center;
      padding:10px 8px;
    }

    .customerBig{
      font-family: Arial, Helvetica, sans-serif;
      font-weight:900;
      text-transform:uppercase;
      letter-spacing:.02em;
      text-align:center;
      line-height:1.05;
      word-break:break-word;
      font-size:72pt; /* auto-fit will adjust */
      max-width:100%;
    }

    .labelFoot{
      display:flex;
      justify-content:space-between;
      align-items:flex-end;
      gap:12px;
      font-family: Arial, Helvetica, sans-serif;
      font-size:14pt;
      font-weight:800;
      color:#000;
    }

    .leftLines{ display:grid; gap:6px; }
    .rightLine{ text-align:right; white-space:nowrap; }

    /* Admin panel */
    .admin{
      margin-top:10px;
      padding:12px;
      border-radius:14px;
      border:1px dashed rgba(148,163,184,.38);
      background:rgba(2,6,23,.35);
    }

    .adminHint{
      font-size:.78rem;
      color:var(--muted);
      margin-top:6px;
    }

    .adminControls{
      margin-top:12px;
      display:none;
      gap:12px;
      flex-direction:column;
    }

    .adminRow{
      display:grid;
      grid-template-columns: 1fr auto;
      gap:10px;
      align-items:end;
    }

    @media (max-width:720px){
      .adminRow{ grid-template-columns: 1fr; }
    }
  </style>
</head>

<body>
  <div class="app">
    <div class="card">
      <div class="title">Label Control</div>

      <div class="grid">
        <div>
          <label for="presetSelect">Customer preset</label>
          <select id="presetSelect">
            <option value="">â€” Select customer â€”</option>
          </select>
        </div>

        <div>
          <label for="customerName">Customer name</label>
          <input id="customerName" placeholder="ACE NJ" />
        </div>

        <div class="row2">
          <div>
            <label for="orderNumber">Order # (optional)</label>
            <input id="orderNumber" placeholder="SO-12345" />
          </div>

          <div>
            <label for="totalPallets">Total pallets (e.g. 12)</label>
            <input id="totalPallets" inputmode="numeric" placeholder="12" />
          </div>
        </div>

        <div class="row2">
          <div>
            <label for="shipDate">Ship date</label>
            <input id="shipDate" type="date" />
          </div>

          <div>
            <label for="startPallet">Start pallet # (optional)</label>
            <input id="startPallet" inputmode="numeric" placeholder="1" />
          </div>
        </div>

        <div class="btnbar">
          <button type="button" onclick="printPalletLabels()">Print Pallet Labels</button>
          <button type="button" class="secondary" onclick="clearFields()">Clear</button>
        </div>

        <div class="helper">
          Prints <b>1 of N</b>, <b>2 of N</b>, ... on separate labels via <code>print.html</code>.
        </div>

        <hr class="divider" />

        <!-- Preview -->
        <div class="previewWrap">
          <div class="label" id="labelPreview">
            <div class="labelTop">
              <div class="brand" id="previewBrand">APOLLON WIRE &amp; CABLE</div>
              <div></div>
            </div>

            <div class="centerBox">
              <div class="customerBig" id="previewCustomer">CUSTOMER</div>
            </div>

            <div class="labelFoot">
              <div class="leftLines">
                <div id="previewOrderLine" style="display:none;">ORDER: <span id="previewOrder"></span></div>
                <div>PALLET: <span id="previewPalletText">1 of 1</span></div>
              </div>
              <div class="rightLine">SHIP: <span id="previewShip">â€”</span></div>
            </div>
          </div>
        </div>

        <!-- Admin -->
        <div class="admin">
          <label for="adminPassword">Admin (manage presets)</label>
          <input type="password" id="adminPassword" placeholder="Enter password" />
          <div class="adminHint">Hint: Hank Jung's 1st year working @ Apollon</div>

          <div class="btnbar" style="margin-top:10px;">
            <button type="button" class="secondary" onclick="unlockAdmin()">Unlock</button>
          </div>

          <div class="adminControls" id="adminControls">
            <div class="adminRow">
              <div>
                <label for="newPresetName">Add preset</label>
                <input id="newPresetName" placeholder="New customer name" />
              </div>
              <button type="button" onclick="addPreset()">Add</button>
            </div>

            <div class="adminRow">
              <div>
                <label for="deletePresetSelect">Delete preset</label>
                <select id="deletePresetSelect"></select>
              </div>
              <button type="button" class="danger" onclick="deletePreset()">Delete</button>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <script>
    // ðŸ”— Your Apps Script Web App URL (same one you already use)
    const API_URL = "https://script.google.com/macros/s/AKfycbyr5srvdX4ZS90bze7PDXNm41sA7VNLcTiO8WBjkcVTdjTThL1bXx24-oAzJ3L0nGsE/exec";

    // Admin password (same as before)
    const ADMIN_PASSWORD = "2024";

    // Elements
    const presetSelect = document.getElementById("presetSelect");
    const deletePresetSelect = document.getElementById("deletePresetSelect");
    const customerNameInput = document.getElementById("customerName");
    const orderNumberInput = document.getElementById("orderNumber");
    const totalPalletsInput = document.getElementById("totalPallets");
    const startPalletInput = document.getElementById("startPallet");
    const shipDateInput = document.getElementById("shipDate");

    const previewCustomer = document.getElementById("previewCustomer");
    const previewOrderLine = document.getElementById("previewOrderLine");
    const previewOrder = document.getElementById("previewOrder");
    const previewPalletText = document.getElementById("previewPalletText");
    const previewShip = document.getElementById("previewShip");

    const adminControls = document.getElementById("adminControls");
    const adminPasswordInput = document.getElementById("adminPassword");
    const newPresetNameInput = document.getElementById("newPresetName");

    // Defaults if API fails
    const defaultCustomerPresets = [
      "City Electric Supply",
      "Graybar",
      "Home Depot",
      "Loweâ€™s",
      "Mr. Supply",
      "Priority Wire & Cable",
      "Turtle & Hughes"
    ];
    let customerPresets = [...defaultCustomerPresets];
    let adminUnlocked = false;

    // Preset dropdown behavior
    presetSelect.addEventListener("change", () => {
      const name = presetSelect.value;
      customerNameInput.value = name || "";
      updatePreview();
    });

    // Build dropdowns
    function buildPresetControls() {
      const sorted = [...customerPresets].sort((a,b)=>a.localeCompare(b, undefined, {sensitivity:"base"}));

      presetSelect.innerHTML = "";
      const ph = document.createElement("option");
      ph.value = "";
      ph.textContent = "â€” Select customer â€”";
      presetSelect.appendChild(ph);

      sorted.forEach(name => {
        const opt = document.createElement("option");
        opt.value = name;
        opt.textContent = name;
        presetSelect.appendChild(opt);
      });

      deletePresetSelect.innerHTML = "";
      sorted.forEach(name => {
        const opt = document.createElement("option");
        opt.value = name;
        opt.textContent = name;
        deletePresetSelect.appendChild(opt);
      });
    }

    async function fetchPresetsFromApi() {
      try {
        const res = await fetch(API_URL + "?action=list", { method: "GET" });
        if (!res.ok) throw new Error("network");
        const data = await res.json();
        if (Array.isArray(data.customers) && data.customers.length) {
          customerPresets = data.customers;
        }
      } catch (e) {
        console.warn("Preset API failed, using defaults.", e);
      }
      buildPresetControls();
    }

    function unlockAdmin() {
      if (adminPasswordInput.value === ADMIN_PASSWORD) {
        adminUnlocked = true;
        adminControls.style.display = "flex";
      } else {
        adminUnlocked = false;
        adminControls.style.display = "none";
        alert("Incorrect password.");
      }
    }

    async function addPreset() {
      if (!adminUnlocked) return alert("Unlock admin first.");
      const name = newPresetNameInput.value.trim();
      if (!name) return;

      try {
        const payload = { action: "add", name, adminKey: ADMIN_PASSWORD };
        const res = await fetch(API_URL, {
          method: "POST",
          body: new URLSearchParams({ payload: JSON.stringify(payload) })
        });
        const text = await res.text();
        const data = JSON.parse(text);
        if (!data.ok) throw new Error(data.error || "add failed");

        newPresetNameInput.value = "";
        await fetchPresetsFromApi();
      } catch (e) {
        console.error(e);
        alert("Error adding preset.");
      }
    }

    async function deletePreset() {
      if (!adminUnlocked) return alert("Unlock admin first.");
      const name = deletePresetSelect.value;
      if (!name) return;

      try {
        const payload = { action: "delete", name, adminKey: ADMIN_PASSWORD };
        const res = await fetch(API_URL, {
          method: "POST",
          body: new URLSearchParams({ payload: JSON.stringify(payload) })
        });
        const text = await res.text();
        const data = JSON.parse(text);
        if (!data.ok) throw new Error(data.error || "delete failed");

        await fetchPresetsFromApi();
      } catch (e) {
        console.error(e);
        alert("Error deleting preset.");
      }
    }

    // Preview auto-fit (for long names)
    function autoFitCustomer() {
      const el = previewCustomer;
      const box = el.parentElement;
      let size = 90;      // start
      const min = 28;
      el.style.fontSize = size + "pt";
      while ((el.scrollWidth > box.clientWidth || el.scrollHeight > box.clientHeight) && size > min) {
        size -= 2;
        el.style.fontSize = size + "pt";
      }
    }

    function formatShip(iso){
      if (!iso) return "â€”";
      const d = new Date(iso + "T00:00:00");
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      const yy = d.getFullYear();
      return `${mm}/${dd}/${yy}`;
    }

    function updatePreview() {
      const customer = customerNameInput.value.trim() || "CUSTOMER";
      previewCustomer.textContent = customer;

      const order = orderNumberInput.value.trim();
      if (order) {
        previewOrder.textContent = order;
        previewOrderLine.style.display = "block";
      } else {
        previewOrderLine.style.display = "none";
      }

      const total = parseInt(totalPalletsInput.value || "1", 10);
      const start = parseInt(startPalletInput.value || "1", 10);
      const safeTotal = Number.isFinite(total) && total > 0 ? total : 1;
      const safeStart = Number.isFinite(start) && start > 0 ? start : 1;

      previewPalletText.textContent = `${safeStart} of ${safeTotal}`;
      previewShip.textContent = formatShip(shipDateInput.value);

      autoFitCustomer();
    }

    [customerNameInput, orderNumberInput, totalPalletsInput, startPalletInput, shipDateInput]
      .forEach(el => el.addEventListener("input", updatePreview));

    function setToday() {
      const t = new Date();
      const yyyy = t.getFullYear();
      const mm = String(t.getMonth() + 1).padStart(2, "0");
      const dd = String(t.getDate()).padStart(2, "0");
      shipDateInput.value = `${yyyy}-${mm}-${dd}`;
    }

    function clearFields() {
      presetSelect.value = "";
      customerNameInput.value = "";
      orderNumberInput.value = "";
      totalPalletsInput.value = "";
      startPalletInput.value = "";
      setToday();
      updatePreview();
      customerNameInput.focus();
    }

    // âœ… This is the missing part you asked about:
    // index.html opens print.html with URL params
    function printPalletLabels() {
      const customer = customerNameInput.value.trim() || "CUSTOMER";
      const order = orderNumberInput.value.trim();
      const total = (totalPalletsInput.value.trim() || "1");
      const start = (startPalletInput.value.trim() || "1");
      const ship = shipDateInput.value; // YYYY-MM-DD

      const url =
        "print.html?customer=" + encodeURIComponent(customer) +
        "&order=" + encodeURIComponent(order) +
        "&total=" + encodeURIComponent(total) +
        "&start=" + encodeURIComponent(start) +
        "&ship=" + encodeURIComponent(ship);

      window.open(url, "_blank");
    }

    window.addEventListener("DOMContentLoaded", () => {
      setToday();
      fetchPresetsFromApi();
      updatePreview();
    });
  </script>
</body>
</html>
